<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feed Data Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base styles using Inter font and CSS Variables for theming */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        /* --- LIGHT MODE VARIABLES (Default) --- */
        :root {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --card-bg: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --border-color: #d1d5db;
            --accent-color: #4f46e5;
            --success-color: #10b981; /* green-500 */
            --error-color: #ef4444;   /* red-500 */
        }

        /* --- DARK MODE VARIABLES --- */
        .dark-mode {
            --bg-color: #111827;
            --text-color: #f3f4f6;
            --card-bg: #1f2937;
            --shadow-color: rgba(255, 255, 255, 0.1);
            --border-color: #4b5563;
            --accent-color: #a5b4fc;
            --success-color: #34d399;
            --error-color: #f87171;
        }

        /* --- GLOBAL STYLES --- */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            padding: 20px; 
            transition: background-color 0.3s, color 0.3s;
        }
        .card { 
            background-color: var(--card-bg); 
            border-radius: 0.5rem; 
            box-shadow: 0 4px 6px -1px var(--shadow-color); 
            padding: 1.5rem; 
            margin-bottom: 1.5rem;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        /* --- INPUT STYLES --- */
        .input-group label { 
            display: block; 
            font-weight: 600; 
            margin-bottom: 0.25rem; 
        }
        .input-group input, .input-group select { 
            width: 100%; 
            padding: 0.5rem; 
            border: 1px solid var(--border-color); 
            border-radius: 0.375rem; 
            margin-bottom: 1rem;
            background-color: var(--card-bg);
            color: var(--text-color);
            transition: border-color 0.3s, background-color 0.3s;
        }

        /* --- BUTTON STYLES --- */
        button { 
            padding: 0.5rem 1rem; 
            border-radius: 0.375rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: background-color 0.2s, opacity 0.2s; 
        }
        .btn-primary { 
            background-color: var(--accent-color); 
            color: var(--card-bg); /* Ensure button text is visible against accent color */
        }
        .btn-primary:hover { 
            opacity: 0.9; 
        }

        /* --- TABLE STYLES --- */
        .table-auto { width: 100%; border-collapse: collapse; }
        .table-auto th { 
            padding: 0.75rem; 
            text-align: left; 
            border-bottom: 2px solid var(--border-color); 
            font-size: 0.875rem; 
            font-weight: 600; 
        }
        .table-auto td { 
            padding: 0.75rem; 
            border-bottom: 1px solid var(--border-color); 
            font-size: 0.875rem; 
        }
        /* Style for Action buttons in the table */
        .action-button {
            padding: 0.25rem 0.5rem;
            margin-right: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .action-button:hover {
            opacity: 0.7;
        }

        /* --- MESSAGE STYLES --- */
        .message-success { color: var(--success-color); }
        .message-error { color: var(--error-color); }


        /* --- DARK MODE TOGGLE STYLES --- */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-switch {
            width: 48px;
            height: 24px;
            background-color: var(--border-color);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: var(--card-bg); 
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active {
            background-color: var(--accent-color);
        }

        .toggle-switch.active::before {
            transform: translateX(24px);
        }
    </style>
</head>
<body>
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Feed Data Management</h1>
        <!-- Dark Mode Toggle -->
        <div class="toggle-container">
            <span class="text-xl">‚òÄÔ∏è</span>
            <div id="dark-mode-toggle" class="toggle-switch"></div>
            <span class="text-xl">üåô</span>
        </div>
    </div>
    
    <div class="card max-w-4xl mx-auto">
        <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Add New Post</h2>
        <div id="error-message" class="mb-4 font-semibold"></div>
        <div id="success-message" class="mb-4 font-semibold"></div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Order ID -->
            <div class="input-group">
                <label for="order-id">Order ID (4 digits)</label>
                <input type="text" id="order-id" placeholder="e.g., 0005" maxlength="4">
                <p id="next-order-id-hint" class="text-xs text-gray-500 mt-[-0.75rem]">Next available: 0000</p>
            </div>
            
            <!-- Date Posted (NEW INPUT) -->
            <div class="input-group">
                <label for="date-posted">Date Posted</label>
                <input type="date" id="date-posted" required>
            </div>

            <!-- Group ID -->
            <div class="input-group">
                <label for="group-id">Group</label>
                <select id="group-id">
                    <!-- Options populated by JS -->
                </select>
            </div>
        </div>

        <!-- Instagram URL -->
        <div class="input-group">
            <label for="instagram-url">Instagram Post URL</label>
            <input type="text" id="instagram-url" placeholder="e.g., https://www.instagram.com/p/B9-Zq0-Fp-X/" required>
        </div>

        <button id="add-post-button" class="btn-primary w-full">Add Post</button>
    </div>

    <div class="card max-w-6xl mx-auto">
        <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Current Posts</h2>
        <div class="overflow-x-auto">
            <table id="posts-table" class="table-auto">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Date</th>
                        <th>Username</th>
                        <th>Group</th>
                        <th>URL</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Posts will be populated by JS -->
                </tbody>
            </table>
        </div>
        <div class="flex justify-end mt-4">
            <button id="save-data-button" class="btn-primary">Save Changes to JSON</button>
        </div>
        
        <div id="save-message" class="mt-4 font-semibold text-center"></div>
    </div>

    <script>
        const LOCAL_STORAGE_KEY_THEME = 'backend_theme';
        const urlInput = document.getElementById('instagram-url');
        const orderIdInput = document.getElementById('order-id');
        const dateInput = document.getElementById('date-posted'); // New
        const groupIdSelect = document.getElementById('group-id');
        const hint = document.getElementById('next-order-id-hint');
        const addPostButton = document.getElementById('add-post-button');
        const saveButton = document.getElementById('save-data-button');
        const postsTableBody = document.querySelector('#posts-table tbody');
        const errorDiv = document.getElementById('error-message');
        const successDiv = document.getElementById('success-message');
        const saveMessageDiv = document.getElementById('save-message');
        const backendContainer = document.querySelector('body');

        let feedData = { groups: [], posts: [] };
        
        // --- DARK MODE LOGIC ---
        
        /**
         * Sets up the dark mode toggle and loads the saved theme preference.
         */
        function setupDarkMode() {
            const body = document.body;
            const toggle = document.getElementById('dark-mode-toggle');

            const savedTheme = localStorage.getItem(LOCAL_STORAGE_KEY_THEME);
            // Default to dark mode if not set
            let isDarkMode = (savedTheme === 'dark' || !savedTheme);
            
            // Apply initial state
            body.classList.toggle('dark-mode', isDarkMode);
            toggle.classList.toggle('active', isDarkMode);
            
            if (!savedTheme) {
                localStorage.setItem(LOCAL_STORAGE_KEY_THEME, isDarkMode ? 'dark' : 'light');
            }

            // Setup click listener
            toggle.addEventListener('click', () => {
                isDarkMode = !isDarkMode;
                body.classList.toggle('dark-mode', isDarkMode);
                toggle.classList.toggle('active', isDarkMode);
                
                // Save new preference
                localStorage.setItem(LOCAL_STORAGE_KEY_THEME, isDarkMode ? 'dark' : 'light');
            });
        }
        
        // --- DATA MANAGEMENT LOGIC ---

        /**
         * Loads the data from the 'feed_data.json' file.
         */
        async function loadData() {
            try {
                // Use fetch to read the file content
                const response = await fetch('feed_data.json');
                if (!response.ok) throw new Error('Failed to load feed_data.json');
                feedData = await response.json();
                
                // Ensure data structure is initialized if file was empty/malformed
                feedData.groups = feedData.groups || [];
                feedData.posts = feedData.posts || [];

                initializeUI();
            } catch (error) {
                console.error('Error loading or parsing feed_data.json:', error);
                // Initialize with empty arrays on error
                feedData = { groups: [], posts: [] };
                initializeUI();
            }
        }

        /**
         * Saves the current feedData object back to 'feed_data.json'.
         */
        async function saveData() {
            try {
                // IMPORTANT: In the Canvas environment, writing to a file is done by 
                // setting the global __file_contents object and setting the appropriate
                // mime type.
                const newContent = JSON.stringify(feedData, null, 2);
                
                if (typeof __file_contents !== 'undefined') {
                    __file_contents['feed_data.json'] = {
                        content: newContent,
                        mimeType: 'application/json'
                    };
                }
                
                saveMessageDiv.textContent = 'Changes saved successfully!';
                saveMessageDiv.classList.remove('message-error');
                saveMessageDiv.classList.add('message-success');
            } catch (error) {
                console.error('Error saving data:', error);
                saveMessageDiv.textContent = 'Error saving changes.';
                saveMessageDiv.classList.remove('message-success');
                saveMessageDiv.classList.add('message-error');
            }
            // Clear message after a delay
            setTimeout(() => {
                saveMessageDiv.textContent = '';
                saveMessageDiv.classList.remove('message-success', 'message-error');
            }, 3000);
        }

        /**
         * Gets the next available order ID by finding the maximum existing ID.
         * @returns {string} The next 4-digit order ID.
         */
        function getNextOrderId() {
            const maxId = feedData.posts.reduce((max, post) => {
                const currentId = parseInt(post.order_id, 10);
                return currentId > max ? currentId : max;
            }, -1);
            
            const nextId = maxId + 1;
            return String(nextId).padStart(4, '0');
        }

        /**
         * Populates the Group ID dropdown.
         */
        function populateGroupSelect() {
            groupIdSelect.innerHTML = ''; // Clear previous options
            feedData.groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = `${group.name} (${group.id})`;
                groupIdSelect.appendChild(option);
            });
        }

        /**
         * Renders the current list of posts into the table.
         */
        function renderPostsTable() {
            postsTableBody.innerHTML = ''; // Clear table body
            
            // Sort by Date Posted (Newest first), then Order ID (Ascending)
            const sortedPosts = [...feedData.posts].sort((a, b) => {
                const dateA = a.date_posted || '0000-01-01';
                const dateB = b.date_posted || '0000-01-01';

                // Primary sort: Date Descending (Newest first)
                if (dateA !== dateB) {
                    return dateB.localeCompare(dateA);
                }
                // Secondary sort: Order ID Ascending
                return a.order_id.localeCompare(b.order_id);
            });
            
            const groupMap = new Map(feedData.groups.map(g => [g.id, g.name]));

            sortedPosts.forEach(post => {
                const row = postsTableBody.insertRow();
                const groupName = groupMap.get(post.group_id) || `Unknown Group (${post.group_id})`;
                
                row.insertCell().textContent = post.order_id;
                row.insertCell().textContent = post.date_posted || 'N/A'; // Display the new date field
                row.insertCell().textContent = post.username;
                row.insertCell().textContent = groupName;
                
                const urlCell = row.insertCell();
                const link = document.createElement('a');
                link.href = post.url;
                link.target = '_blank';
                link.textContent = 'View Post';
                link.className = 'text-blue-500 hover:underline';
                urlCell.appendChild(link);
                
                const actionsCell = row.insertCell();
                
                // Delete Button
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.className = 'action-button bg-red-600 text-white hover:bg-red-700';
                deleteBtn.onclick = () => deletePost(post.order_id);
                actionsCell.appendChild(deleteBtn);
            });
        }
        
        /**
         * Removes a post from the data based on its order_id.
         * @param {string} orderId The 4-digit order ID of the post to delete.
         */
        function deletePost(orderId) {
            // Filter out the post with the matching order_id
            const initialCount = feedData.posts.length;
            feedData.posts = feedData.posts.filter(post => post.order_id !== orderId);
            
            if (feedData.posts.length < initialCount) {
                // Success message on delete
                successDiv.classList.remove('message-error');
                successDiv.classList.add('message-success');
                successDiv.textContent = `Post with ID ${orderId} deleted.`;
                errorDiv.textContent = '';
            } else {
                 // Error message if post wasn't found (shouldn't happen with button clicks)
                errorDiv.classList.remove('message-success');
                errorDiv.classList.add('message-error');
                errorDiv.textContent = `Error: Post with ID ${orderId} not found.`;
                successDiv.textContent = '';
            }
            
            // Re-initialize UI to show the new table and hint
            initializeUI(); 
            // Clear message after a delay
            setTimeout(() => {
                successDiv.textContent = '';
                errorDiv.textContent = '';
                successDiv.classList.remove('message-success');
                errorDiv.classList.remove('message-error');
            }, 3000);
        }

        /**
         * Parses an Instagram URL to extract the username.
         * @param {string} url The Instagram post URL.
         * @returns {{username: string, url: string} | null} Parsed data or null if invalid.
         */
        function parseInstagramUrl(url) {
            try {
                const urlObj = new URL(url);
                if (urlObj.hostname.includes('instagram.com') && urlObj.pathname.startsWith('/p/')) {
                    // Pathname looks like /p/DJsyrbmRwP0/user_name/
                    // The username can be inferred from the main page structure but is not
                    // reliably in the /p/ URL. For simplicity, we will assume the
                    // username is the first segment before /p/ in the path, or a placeholder
                    // if that fails. (Original logic assumed username from path, let's keep it simple)
                    
                    // Simple regex to extract what looks like a username before /p/
                    const match = url.match(/instagram\.com\/(.+?)\/p\//);
                    let username = 'unknown_user';
                    if (match && match[1] && !match[1].includes('p')) {
                        username = match[1].replace(/\//g, '');
                    }
                    
                    // Sanitize URL to ensure it is the permanent /p/ link structure
                    // The component after /p/ is the post ID, anything after that should be removed for the embed link
                    const parts = urlObj.pathname.split('/').filter(p => p);
                    const pIndex = parts.indexOf('p');
                    let cleanUrl = url;

                    if (pIndex !== -1 && pIndex + 1 < parts.length) {
                        const postCode = parts[pIndex + 1];
                        // Reconstruct the clean URL without any trailing username/slug
                        cleanUrl = `https://www.instagram.com/p/${postCode}/`;
                        
                        // If the URL was more complex, try to guess username from a preceding segment if available
                        if (pIndex > 0) {
                            username = parts[pIndex - 1];
                        }
                    }

                    return {
                        username: username,
                        url: cleanUrl
                    };
                }
            } catch (e) {
                console.error("URL parsing error:", e);
                return null;
            }
            return null;
        }

        /**
         * Handles the button click to add a new post.
         */
        addPostButton.addEventListener('click', () => {
            const url = urlInput.value.trim();
            const orderId = orderIdInput.value.trim().padStart(4, '0');
            const groupId = groupIdSelect.value;
            const postDate = dateInput.value; // Get date input (YYYY-MM-DD format)

            // Clear previous messages
            successDiv.textContent = '';
            errorDiv.textContent = '';
            successDiv.classList.remove('message-success', 'message-error');
            errorDiv.classList.remove('message-success', 'message-error');

            if (!url || !orderId || !groupId || !postDate) {
                errorDiv.classList.add('message-error');
                errorDiv.textContent = 'Please fill out all fields (URL, Order ID, Date, Group).';
                return;
            }

            const parsed = parseInstagramUrl(url);

            if (!parsed) {
                errorDiv.classList.add('message-error');
                errorDiv.textContent = 'Invalid Instagram URL format. Must be a link to a post (e.g., /p/...).';
                return;
            }

            // 1. Check if the specified Order ID already exists for collision detection
            if (feedData.posts.some(p => p.order_id === orderId && p.date_posted === postDate)) {
                // Collision detected only if ID AND Date match. Bump all posts with matching date and ID >= the target ID
                feedData.posts.forEach(post => {
                    if (post.date_posted === postDate && post.order_id >= orderId) {
                        const nextNum = parseInt(post.order_id, 10) + 1;
                        post.order_id = String(nextNum).padStart(4, '0');
                    }
                });
            }


            const newPost = {
                order_id: orderId, // Use the user-specified/padded ID
                username: parsed.username || 'unknown_user', // Fallback just in case
                group_id: groupId,
                url: parsed.url,
                date_posted: postDate // NEW FIELD
            };

            feedData.posts.push(newPost);
            
            // Success message and clear
            successDiv.classList.add('message-success');
            successDiv.textContent = `Post added for @${newPost.username} (Order ID: ${newPost.order_id}).`;
            urlInput.value = '';
            dateInput.value = ''; // Clear date input
            
            // Re-initialize UI to update next order ID and output
            initializeUI(); 
            
            // Clear message after a delay
            setTimeout(() => {
                successDiv.textContent = '';
                errorDiv.textContent = '';
                successDiv.classList.remove('message-success');
                errorDiv.classList.remove('message-error');
            }, 5000);
        });
        
        /**
         * Initializes or re-initializes the UI elements.
         */
        function initializeUI() {
            // Update next order ID hint
            const nextId = getNextOrderId();
            hint.textContent = `Next available: ${nextId}`;
            orderIdInput.value = nextId;
            
            // Populate groups
            populateGroupSelect();
            
            // Render the table
            renderPostsTable();
        }

        // Start loading data and set up theme when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            setupDarkMode(); // Initialize dark mode first
            loadData();
            saveButton.addEventListener('click', saveData);
        });
    </script>
</body>
</html>
